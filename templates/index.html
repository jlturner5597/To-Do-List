<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do List</title>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- DOMPurify for XSS protection -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js" integrity="sha384-irShVGbS5pg+p2c/R5P8Ix7BM8WOHWlb3BbL4T1DKLY7x9BfjMb5HGUpKxSx/6V9" crossorigin="anonymous"></script>
</head>
<body>
    <!-- Flash messages for user notifications -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-container">
                {% for category, message in messages %}
                    <div class="flash-message flash-{{ category }}" onclick="this.remove()">
                        {{ message }}
                        <span class="flash-close">&times;</span>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    
    <div class="container">
        <header class="header">
            <div class="header-row">
                <h1>To-Do List</h1>
                <div class="header-actions">
                    <span class="user-info">{{ current_user.username }}</span>
                    <a href="{{ url_for('auth.logout') }}" class="logout-btn" title="Logout">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                    </a>
                    <button id="settings-btn" class="settings-btn" title="Settings" aria-label="Toggle settings">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="10" cy="10" r="3"/>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" transform="scale(0.83) translate(0, 0)"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="settings-panel" class="settings-panel">
                <div class="settings-content">
                    <label class="setting-item">
                        <span class="setting-label">Dark Mode</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="dark-mode-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </label>
                    <label class="setting-item">
                        <span class="setting-label">Show Archived</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="show-archived-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </label>
                    
                    <div class="settings-divider"></div>
                    
                    <div class="setting-item google-calendar-setting">
                        <div class="setting-header">
                            <svg class="google-calendar-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            <span class="setting-label">Google Calendar</span>
                        </div>
                        <div id="google-calendar-status" class="google-calendar-status">
                            <span class="status-indicator" id="gcal-status-indicator"></span>
                            <span class="status-text" id="gcal-status-text">Checking...</span>
                        </div>
                        <div id="google-calendar-actions" class="google-calendar-actions">
                            <button id="gcal-connect-btn" class="gcal-btn gcal-connect" style="display: none;">
                                Connect
                            </button>
                            <button id="gcal-disconnect-btn" class="gcal-btn gcal-disconnect" style="display: none;">
                                Disconnect
                            </button>
                        </div>
                        <p id="gcal-not-configured" class="gcal-notice" style="display: none;">
                            Configure Google API credentials to enable sync.
                        </p>
                    </div>
                </div>
            </div>
        </header>

        <main class="main">
            <div class="card">
                <form id="todo-form" class="add-form">
                    <input 
                        type="text" 
                        id="todo-input" 
                        placeholder="What needs to be done?" 
                        autocomplete="off"
                    >
                    <div class="datetime-inputs">
                        <input 
                            type="date" 
                            id="deadline-date-input"
                            title="Set deadline date (optional)"
                        >
                        <input 
                            type="time" 
                            id="deadline-time-input"
                            title="Set deadline time (optional)"
                        >
                    </div>
                    <button type="submit">Add</button>
                </form>

                <ul id="todo-list" class="todo-list">
                    <!-- To-do items will be inserted here -->
                </ul>

                <div id="empty-state" class="empty-state">
                    <p>No tasks yet. Add one above!</p>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <script nonce="{{ csp_nonce() }}">
        // CSRF token helper for secure requests
        function getCsrfToken() {
            const match = document.cookie.match(/csrf_token=([^;]+)/);
            return match ? match[1] : '';
        }

        // Secure fetch wrapper that includes CSRF token
        async function secureFetch(url, options = {}) {
            const headers = options.headers || {};
            if (options.method && options.method !== 'GET') {
                headers['X-CSRFToken'] = getCsrfToken();
            }
            return fetch(url, { ...options, headers });
        }

        const form = document.getElementById('todo-form');
        const input = document.getElementById('todo-input');
        const deadlineDateInput = document.getElementById('deadline-date-input');
        const deadlineTimeInput = document.getElementById('deadline-time-input');
        const todoList = document.getElementById('todo-list');
        const emptyState = document.getElementById('empty-state');

        // Settings elements
        const settingsBtn = document.getElementById('settings-btn');
        const settingsPanel = document.getElementById('settings-panel');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const showArchivedToggle = document.getElementById('show-archived-toggle');

        // Google Calendar elements
        const gcalStatusIndicator = document.getElementById('gcal-status-indicator');
        const gcalStatusText = document.getElementById('gcal-status-text');
        const gcalConnectBtn = document.getElementById('gcal-connect-btn');
        const gcalDisconnectBtn = document.getElementById('gcal-disconnect-btn');
        const gcalNotConfigured = document.getElementById('gcal-not-configured');

        // Load todos and settings on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadDarkModePreference();
            loadShowArchivedPreference();
            loadGoogleCalendarStatus();
            loadTodos();
        });

        // Toggle settings panel
        settingsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            settingsPanel.classList.toggle('open');
        });

        // Close settings panel when clicking outside
        document.addEventListener('click', (e) => {
            if (!settingsPanel.contains(e.target) && !settingsBtn.contains(e.target)) {
                settingsPanel.classList.remove('open');
            }
        });

        // Dark mode toggle handler
        darkModeToggle.addEventListener('change', () => {
            document.body.classList.toggle('dark', darkModeToggle.checked);
            localStorage.setItem('darkMode', darkModeToggle.checked ? 'true' : 'false');
        });

        // Load dark mode preference from localStorage
        function loadDarkModePreference() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            darkModeToggle.checked = darkMode;
            document.body.classList.toggle('dark', darkMode);
        }

        // Show archived toggle handler
        showArchivedToggle.addEventListener('change', () => {
            localStorage.setItem('showArchived', showArchivedToggle.checked ? 'true' : 'false');
            loadTodos();
        });

        // Load show archived preference from localStorage
        function loadShowArchivedPreference() {
            const showArchived = localStorage.getItem('showArchived') === 'true';
            showArchivedToggle.checked = showArchived;
        }

        // Google Calendar status and connection handlers
        async function loadGoogleCalendarStatus() {
            try {
                const response = await fetch('/api/google/status');
                const status = await response.json();
                
                if (!status.configured) {
                    gcalStatusIndicator.className = 'status-indicator not-configured';
                    gcalStatusText.textContent = 'Not configured';
                    gcalNotConfigured.style.display = 'block';
                    gcalConnectBtn.style.display = 'none';
                    gcalDisconnectBtn.style.display = 'none';
                } else if (status.connected) {
                    gcalStatusIndicator.className = 'status-indicator connected';
                    gcalStatusText.textContent = 'Connected';
                    gcalNotConfigured.style.display = 'none';
                    gcalConnectBtn.style.display = 'none';
                    gcalDisconnectBtn.style.display = 'block';
                } else {
                    gcalStatusIndicator.className = 'status-indicator disconnected';
                    gcalStatusText.textContent = 'Not connected';
                    gcalNotConfigured.style.display = 'none';
                    gcalConnectBtn.style.display = 'block';
                    gcalDisconnectBtn.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading Google Calendar status:', error);
                gcalStatusIndicator.className = 'status-indicator error';
                gcalStatusText.textContent = 'Error';
            }
        }

        // Connect to Google Calendar
        gcalConnectBtn.addEventListener('click', () => {
            window.location.href = '/api/google/auth';
        });

        // Disconnect from Google Calendar
        gcalDisconnectBtn.addEventListener('click', async () => {
            try {
                gcalDisconnectBtn.disabled = true;
                gcalDisconnectBtn.textContent = 'Disconnecting...';
                
                const response = await secureFetch('/api/google/disconnect', { method: 'POST' });
                
                if (response.ok) {
                    loadGoogleCalendarStatus();
                } else {
                    console.error('Failed to disconnect');
                }
            } catch (error) {
                console.error('Error disconnecting:', error);
            } finally {
                gcalDisconnectBtn.disabled = false;
                gcalDisconnectBtn.textContent = 'Disconnect';
            }
        });

        // Combine date and time into ISO timestamp
        function combineDateTime(dateStr, timeStr) {
            if (!dateStr) return null;
            if (timeStr) {
                return `${dateStr}T${timeStr}:00`;
            }
            return `${dateStr}T00:00:00`;
        }

        // Handle form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = input.value.trim();
            if (!text) return;

            const deadline = combineDateTime(deadlineDateInput.value, deadlineTimeInput.value);

            try {
                const response = await secureFetch('/api/todos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, deadline })
                });

                if (response.ok) {
                    input.value = '';
                    deadlineDateInput.value = '';
                    deadlineTimeInput.value = '';
                    loadTodos();
                }
            } catch (error) {
                console.error('Error adding todo:', error);
            }
        });

        // Format datetime as readable string (e.g., "Jan 15" or "Jan 15, 2:30 PM")
        function formatDeadline(deadlineString) {
            if (!deadlineString) return '';
            const date = new Date(deadlineString);
            const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            
            // Check if time is set (not midnight)
            const hours = date.getHours();
            const minutes = date.getMinutes();
            if (hours === 0 && minutes === 0) {
                return dateStr;
            }
            
            const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            return `${dateStr}, ${timeStr}`;
        }

        // Check if a deadline is overdue
        function isOverdue(deadlineString) {
            if (!deadlineString) return false;
            const deadline = new Date(deadlineString);
            const now = new Date();
            return deadline < now;
        }

        // Load all todos from the API
        async function loadTodos() {
            try {
                // Clear Quill instances before reloading
                descriptionQuillInstances.clear();
                notesQuillInstances.clear();
                
                const includeArchived = showArchivedToggle.checked;
                const url = includeArchived ? '/api/todos?include_archived=true' : '/api/todos';
                const response = await fetch(url);
                const todos = await response.json();
                renderTodos(todos);
            } catch (error) {
                console.error('Error loading todos:', error);
            }
        }

        // Render todos to the page
        function renderTodos(todos) {
            todoList.innerHTML = '';

            if (todos.length === 0) {
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            todos.forEach(todo => {
                const li = document.createElement('li');
                li.className = 'todo-item-container';
                li.dataset.id = todo.id;

                // Main row
                const mainRow = document.createElement('div');
                mainRow.className = 'todo-item' + (todo.completed ? ' completed' : '') + (todo.archived ? ' archived' : '');

                // Check if overdue
                if (todo.deadline && !todo.completed && !todo.archived && isOverdue(todo.deadline)) {
                    mainRow.classList.add('overdue');
                }

                // Expand button
                const expandBtn = document.createElement('button');
                expandBtn.className = 'expand-btn';
                expandBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 6 8 10 12 6"></polyline></svg>';
                expandBtn.title = 'Expand details';
                expandBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleExpand(li, todo);
                });

                const checkbox = document.createElement('span');
                checkbox.className = 'checkbox';
                checkbox.innerHTML = todo.completed ? '✓' : '';
                checkbox.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleTodo(todo.id);
                });

                const text = document.createElement('span');
                text.className = 'todo-text';
                text.textContent = todo.text;

                // Indicator if has description or notes
                if (todo.description || todo.notes) {
                    const hasDetailsIndicator = document.createElement('span');
                    hasDetailsIndicator.className = 'has-details-indicator';
                    hasDetailsIndicator.title = 'Has details';
                    text.appendChild(hasDetailsIndicator);
                }

                mainRow.appendChild(expandBtn);
                mainRow.appendChild(checkbox);
                mainRow.appendChild(text);

                // Add deadline display if set
                if (todo.deadline) {
                    const deadlineSpan = document.createElement('span');
                    deadlineSpan.className = 'todo-deadline';
                    deadlineSpan.textContent = formatDeadline(todo.deadline);
                    mainRow.appendChild(deadlineSpan);
                }

                const archiveBtn = document.createElement('button');
                archiveBtn.className = 'archive-btn';
                archiveBtn.innerHTML = todo.archived 
                    ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>'
                    : '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 8v13H3V8"></path><path d="M1 3h22v5H1z"></path><path d="M10 12h4"></path></svg>';
                archiveBtn.title = todo.archived ? 'Unarchive' : 'Archive';
                archiveBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleArchive(todo.id, !todo.archived);
                });

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '×';
                deleteBtn.title = 'Delete';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteTodo(todo.id);
                });

                mainRow.appendChild(archiveBtn);
                mainRow.appendChild(deleteBtn);

                // Detail panel (hidden by default)
                const detailPanel = document.createElement('div');
                detailPanel.className = 'todo-detail-panel';
                detailPanel.innerHTML = `
                    <div class="detail-field">
                        <label>Description</label>
                        <div class="description-editor-container">
                            <div class="description-editor"></div>
                        </div>
                    </div>
                    <div class="detail-field">
                        <label>Notes</label>
                        <div class="notes-editor-container">
                            <div class="notes-editor"></div>
                        </div>
                    </div>
                    <div class="detail-actions">
                        <button class="save-details-btn">Save</button>
                    </div>
                `;
                // Store todo data for later initialization
                detailPanel.dataset.description = todo.description || '';
                detailPanel.dataset.notes = todo.notes || '';

                li.appendChild(mainRow);
                li.appendChild(detailPanel);
                todoList.appendChild(li);
            });
        }

        // Store Quill instances (description and notes editors per todo)
        const descriptionQuillInstances = new Map();
        const notesQuillInstances = new Map();

        // Quill toolbar configuration
        const quillToolbarConfig = [
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['link'],
            ['clean']
        ];

        // Check if Quill loaded successfully
        const isQuillAvailable = typeof Quill !== 'undefined';

        // Toggle expand/collapse for task details
        function toggleExpand(container, todo) {
            const isExpanded = container.classList.contains('expanded');
            
            // Collapse all other expanded items first
            document.querySelectorAll('.todo-item-container.expanded').forEach(item => {
                if (item !== container) {
                    item.classList.remove('expanded');
                    const expandBtn = item.querySelector('.expand-btn');
                    if (expandBtn) expandBtn.classList.remove('rotated');
                }
            });

            if (isExpanded) {
                container.classList.remove('expanded');
                container.querySelector('.expand-btn').classList.remove('rotated');
            } else {
                container.classList.add('expanded');
                container.querySelector('.expand-btn').classList.add('rotated');
                
                const detailPanel = container.querySelector('.todo-detail-panel');
                
                // Check if Quill is available
                if (!isQuillAvailable) {
                    console.error('Quill editor failed to load. Rich text editing is unavailable.');
                    detailPanel.innerHTML = `
                        <div class="editor-error">
                            <p>Rich text editor failed to load. Please refresh the page or check your internet connection.</p>
                        </div>
                    `;
                    return;
                }
                
                // Initialize Description Quill editor if not already done
                if (!descriptionQuillInstances.has(todo.id)) {
                    try {
                        const descEditor = container.querySelector('.description-editor');
                        const descQuill = new Quill(descEditor, {
                            theme: 'snow',
                            placeholder: 'Add a description...',
                            modules: { toolbar: quillToolbarConfig }
                        });
                        
                        // Set initial content (sanitized for XSS protection)
                        const descContent = detailPanel.dataset.description;
                        if (descContent) {
                            descQuill.root.innerHTML = DOMPurify.sanitize(descContent);
                        }
                        
                        descriptionQuillInstances.set(todo.id, descQuill);
                    } catch (error) {
                        console.error('Failed to initialize description editor:', error);
                    }
                }
                
                // Initialize Notes Quill editor if not already done
                if (!notesQuillInstances.has(todo.id)) {
                    try {
                        const notesEditor = container.querySelector('.notes-editor');
                        const notesQuill = new Quill(notesEditor, {
                            theme: 'snow',
                            placeholder: 'Add notes with rich formatting...',
                            modules: { toolbar: quillToolbarConfig }
                        });
                        
                        // Set initial content (sanitized for XSS protection)
                        const notesContent = detailPanel.dataset.notes;
                        if (notesContent) {
                            notesQuill.root.innerHTML = DOMPurify.sanitize(notesContent);
                        }
                        
                        notesQuillInstances.set(todo.id, notesQuill);
                    } catch (error) {
                        console.error('Failed to initialize notes editor:', error);
                    }
                }
                
                // Setup save button
                const saveBtn = container.querySelector('.save-details-btn');
                saveBtn.onclick = () => saveDetails(container, todo.id);
            }
        }

        // Save task details
        async function saveDetails(container, todoId) {
            // Get description from Quill editor
            const descQuill = descriptionQuillInstances.get(todoId);
            const descriptionHtml = descQuill ? descQuill.root.innerHTML : '';
            const description = descriptionHtml === '<p><br></p>' ? '' : descriptionHtml;
            
            // Get notes from Quill editor
            const notesQuill = notesQuillInstances.get(todoId);
            const notesHtml = notesQuill ? notesQuill.root.innerHTML : '';
            const notesContent = notesHtml === '<p><br></p>' ? '' : notesHtml;
            
            try {
                const response = await secureFetch(`/api/todos/${todoId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description, notes: notesContent })
                });

                if (response.ok) {
                    // Show save confirmation
                    const saveBtn = container.querySelector('.save-details-btn');
                    const originalText = saveBtn.textContent;
                    saveBtn.textContent = 'Saved!';
                    saveBtn.classList.add('saved');
                    setTimeout(() => {
                        saveBtn.textContent = originalText;
                        saveBtn.classList.remove('saved');
                    }, 1500);
                    
                    // Reload to update the details indicator
                    loadTodos();
                }
            } catch (error) {
                console.error('Error saving details:', error);
            }
        }

        // Toggle todo completion status
        async function toggleTodo(id) {
            try {
                const response = await secureFetch(`/api/todos/${id}`, {
                    method: 'PUT'
                });

                if (response.ok) {
                    loadTodos();
                }
            } catch (error) {
                console.error('Error toggling todo:', error);
            }
        }

        // Delete a todo
        async function deleteTodo(id) {
            try {
                const response = await secureFetch(`/api/todos/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadTodos();
                }
            } catch (error) {
                console.error('Error deleting todo:', error);
            }
        }

        // Toggle archive status
        async function toggleArchive(id, archived) {
            try {
                const response = await secureFetch(`/api/todos/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ archived })
                });

                if (response.ok) {
                    loadTodos();
                }
            } catch (error) {
                console.error('Error archiving todo:', error);
            }
        }
    </script>
</body>
</html>
